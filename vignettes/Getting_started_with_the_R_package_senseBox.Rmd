---
title: "Getting started with the R-package senseBox"
author: "Johannes Friedrich"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    fig_caption: yes
    fig_height: 5
    fig_width: 5
    number_sections: yes
    toc: yes
vignette: >
  %\VignetteIndexEntry{Getting started with the R-package senseBox}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      fig.align = "center")
```


# Motivation


# Usage

First we show a little bit of senseBox statistics with the function `get_senseBox_stats()`. Then we list all available senseBoxes with their Id and name. We choose an Id from a senseBox which is located in Berlin, Germany.

```{r}
library(senseBox)

stats <- get_senseBox_stats()

list <- get_senseBox_Ids(txtProgressBar = FALSE)
senseBoxId <- c("592ca4b851d3460011ea2635")
```

```{r, echo = FALSE}
knitr::kable(
  stats, format = "html"
)
```


See where is the box located? We can easily get an overview and map the location. 
First we extract the coordinates of the senseBox. This can be done with `get_senseBox_location()`.
Note that some extra packages are necessary to display the locations interactively.

```{r}
location <- get_senseBox_location(senseBoxId)

library(leaflet)
library(htmltools)

leaflet(location) %>%
  addTiles() %>%  
  addMarkers(~long, ~lat, popup = ~htmltools::htmlEscape(name))
```

But now to the main part of the package: downloading and analysing data from senseBoxes.

* Get sensor Ids from a senseBox
* Show some information about the sensor
* Download the recorded data from the sensors



```{r}
sensor_info <- get_senseBox_sensor_info(senseBoxId)

knitr::kable(
  sensor_info[[1]][,1:5],
  format = "html"
)
```


We can now download data from the senseBox, either from a specific sensorId or from all sensors within the sensBox.
In the following we are downloading all available sensors.

```{r}
data_all <- get_senseBox_data(senseBoxId)
```


When you are interested in just a selection of sensors, just submit the sensorIds to the function `get_senseBox_data()`.

```{r}
sensor_ids <- get_senseBox_sensor_Ids(senseBoxId)

data_sel <- get_senseBox_data(senseBoxId, 
                              sensorId = list(sensor_ids[[1]][1:2]))
```

When using the above code, by defatult, the data from the last 48 h will be downloaded. You can donwload up to 10,000 records and sepcify the date of the record. The maximum time frame for downloading data is back to one month from now.
Use the argument `fromDate` and `toDate` to specify the desired time frame. 

```{r eval = FALSE}
data_timeframe <- get_senseBox_data(senseBoxId, 
                                    sensor_ids, 
                                    fromDate = "2017-11-11 11:11:11", 
                                    toDate = "2017-11-14 11:11:11")
```

Visualising the results from all sensors is one of the main aims and we recommend using the **R**-package `ggplot2`. 
We provide a sample code next and you just have to change the data executed in the function `melt()`.

```{r}
library(ggplot2)
library(reshape2)
library(scales)

data_melt <- melt(data_all[[1]], id.vars = c("createdAt", "value"))

ggplot(data_melt, aes(x=createdAt, y = value, colour = L1)) +
  geom_line() +
  scale_x_datetime(labels = date_format("%H:%M:%S", tz = Sys.timezone())) +
  facet_wrap(~L1, scales = "free") +
  theme(legend.position = "bottom",
        legend.title = element_blank())

```

